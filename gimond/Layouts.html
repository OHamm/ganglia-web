<!DOCTYPE html>
<html>

   <head>
      <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
      <meta content="utf-8" http-equiv="encoding">
      <script type="text/javascript" src="../js/jquery-1.9.1.min.js"></script>
      <script type="text/javascript" src="../js/d3.v2.min.js"></script>
      <link rel="stylesheet" type="text/css" href="stylesheet.css"/>
   </head>

   <body>
      <h2>Gmetad's metrics monitoring page</h2>
      <div id="buttons">
         <button type="button" id="update" value="Update" onclick="updateMetrics()">Update</button>
         <label><input type="checkbox" id="autoUpdateCheck">Auto Update</label>
         <label><input type="number" id="interval"/>Interval (s)</label>
         <label><input type="number" id="rows"/>Number of Rows</label>
         <label><input type="number" id="graphs_width"/>Width of graphs (px)</label>
         <label><input type="number" id="graphs_height"/>Height of graphs (px)</label>
      </div>

      <span id="metrics" value=-1></span>

      <script type="text/javascript">
         var timerId;
         var nowTime;
         var arrData = {};
         var graphShown = {};

         function checkAutoUpdate(){
            return !document.getElementById("autoUpdateCheck").checked && document.getElementById("update").value == "Update";
         }

         function retrieveVal(txt){
            var val = document.getElementById(txt).value;
            return (isNaN(val) || val <= 0) ? 0 : val;
         }

         function autoUpdateMetrics(){
            if(document.getElementById("update").value == "Update"){
               var val = retrieveVal("interval");
               if(val != 0){
                  document.getElementById("update").value = "Stop";
                  $('#update').text("Stop");
                  timerId = setInterval(updateM, val * 1000);
               }
            }else{
               document.getElementById("update").value = "Update";
               $('#update').text("Update");
               clearTimeout(timerId);
            }
         }
         function updateMetrics(){
            if(checkAutoUpdate()){
               updateM();
            }else{
               updateM();
               autoUpdateMetrics();
            }
         }
         //This is just here for testing purposes so I don't forget something while I code...
         function testingfun(txt){
            console.log(txt);
         }

         function updateM(){
            nowTime = $.now();
            var Gmetad = "http://" + window.location.hostname + ":8652/status";
            $.ajax({
            type: "GET",
            url: Gmetad,
            dataType: "jsonp",
            crossDomain: true,
            contentType: "application/json",
            jsonpCallback: "jsonCallback",
            error: function(data, textStatus, jqXHR) { alert("Update crashed, please reload the page..."); console.log(textStatus + " " + jqXHR.responseText);}
            /* If the logged error is "parsererror undefined", then the ajax() call couldn't parse the json data
            because there was a conflict with another call to ajax(), and sometimes the metrics won't update anymore. */
            });
         }

         var speedKeyUp = {"host":false, "gridname":false, "version":false, "boottime":false, "uptime":false,
         "uptimeMillis":false, "cpu_num":false, "cpu_speed":false, "disk_total":false, "mem_total":false,
         "swap_total":false, "sys_clock":false, "machine_type":false, "os_name":false, "os_release":false};
         function testkey(key){
            return !speedKeyUp.hasOwnProperty(key);
         }

         var speedMetricUp = {"core":false, "cpu":false, "disk":false, "load":false, "memory":false, "network":false,
         "process":false, "system":false, "other":false, "received":false, "sent":false};
         function testmetric(key){
            return speedMetricUp.hasOwnProperty(key);
         }

         function jsonCallback(data){
            if($("#metrics").attr('value') == -1){
               $("#metrics").html(linearTableTh(data, data.stattime/1000));
               $("#metrics").attr('value', 0);
               linearTable(data, data.stattime/1000);
            }else{
               linearTable(data, data.stattime/1000);
               $("#metrics").attr('value', +$("#metrics").attr('value') + 1);
            }
            var val = retrieveVal("rows");
            val = val > 0 ? val : 1;
            var currentVal = +$("#metrics").attr('value');
            var currentVarTmp;
            $.each($("#metrics table"),function(){
               currentVarTmp = currentVal;
               while(currentVarTmp >= val){
                  $("#metrics #" + this.id + " tr:last").remove();
                  currentVarTmp --;
               }
            });
            $("#metrics").attr('value', currentVarTmp);
         }

         function turnGraphOnOff(key){
            graphShown[key] = !graphShown[key];
            if(graphShown[key]){
               drawGraph(key, arrData[key]);
            }else{
               d3.select("#"+key).remove();
            }
         }

         function linearTableTh(data, time){
            var txt = "";
            $.each(data, function(key, val) {
               if(key == "metrics"){
                  txt = '<h1>general:</h1><table id="general">' + txt + '</table>';
                  txt += linearTableTh(val, time);
               }else if(testmetric(key)){
                  txt += '<h1>' + key + ':</h1><table id="' + key + '">' + linearTableTh(val, time) + '</table>';
               }else if(key == "stattime"){
                  txt +='<th>' + key + '</th>';
                  arrData["call_delay"] = [];
                  arrData["call_delay"].push([time, ($.now() - nowTime)]);
                  txt +='<th><button onclick="turnGraphOnOff(\'call_delay\')">call_delay</button></th>';
                  graphShown["call_delay"] = false;
               }else{
                  if(testkey(key)){
                     txt +='<th><button onclick="turnGraphOnOff(\'' + key + '\')">' + key + '</button></th>';
                     graphShown[key] = false;
                     arrData[key] = [];
                     arrData[key].push([time, val]);
                  }else{
                     txt +='<th>' + key + '</th>';
                  }
               }
            });
            return txt;
         }

         function linearTable(data, time){
            var txt = "";
            $.each(data, function(key, val) {
               if(key == "metrics"){
                  $("#metrics #general tr:nth-child(1)").after('<tr>' + txt + '</tr>');
                  linearTable(val, time);
               }else if(testmetric(key)){
                  $("#metrics #" + key + " tr:nth-child(1)").after('<tr>' + linearTable(val, time) + '</tr>');
               }else if(key == "stattime"){
                  txt +='<td>' + val + '</td>';
                  txt +='<td>' + ($.now() - nowTime) + '</td>';
                  arrData["call_delay"].push([time, ($.now() - nowTime)]);
                  if(graphShown["call_delay"]){
                     drawGraph("call_delay", arrData["call_delay"]);
                  }
               }else{
                  txt +='<td>' + val + '</td>';
                  if(testkey(key)){
                     arrData[key].push([time, val]);
                     if(graphShown[key]){
                        drawGraph(key, arrData[key]);
                     }
                  }
               }
            });
            return txt;
         }

      function drawGraph(label, data){
         d3.select("#"+label).remove();
         var tmpWidth = retrieveVal("graphs_width");
         var tmpHeight = retrieveVal("graphs_height");

         var margin = {top: 20, right: 20, bottom: 30, left: 50},
            width = (tmpWidth > 0 ? tmpWidth : 700) - margin.left - margin.right,
            height = (tmpHeight > 0 ? tmpHeight : 300) - margin.top - margin.bottom;

         var x = d3.time.scale()
            .range([0, width])

         var y = d3.scale.linear()
            .range([height, 0]);

         var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

         var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

         var line = d3.svg.line()
            .x(function(d) { return x(d[0]); })
            .y(function(d) { return y(d[1]); });

         var svg = d3.select("body").append("svg")
            .attr("id",label)
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

         x.domain(d3.extent(data, function(d) { return d[0]; }));
         y.domain(d3.extent(data, function(d) { return d[1]; }));

         svg.append("g")
               .attr("class", "x axis")
               .attr("transform", "translate(0," + height + ")")
               .call(xAxis)
            .append("text")
               .attr("y", 6)
               .attr("dy", ".71em")
               .style("text-anchor", "end")
               .text("Time");

         svg.append("g")
               .attr("class", "y axis")
               .call(yAxis)
            .append("text")
               .attr("transform", "rotate(-90)")
               .attr("y", 6)
               .attr("dy", ".71em")
               .style("text-anchor", "end")
               .text(label);

         svg.append("path")
               .datum(data)
               .attr("class", "line")
               .attr("d", line);
      }

      window.onload = function() {
         updateM();
      };
      </script>

   </body>

</html>