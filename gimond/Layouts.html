<!DOCTYPE html>
<html>

   <head>
      <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
      <meta content="utf-8" http-equiv="encoding">
      <script type="text/javascript" src="../js/jquery-1.9.1.min.js"></script>
      <script type="text/javascript" src="../js/d3.v2.min.js"></script>
      <link rel="stylesheet" type="text/css" href="stylesheet.css"/>
   </head>

   <body>
      <h2>Testing metrics</h2>
      <buttons>
      <button type="button" id="update" value="Update" onclick="updateMetrics()">Update</button>
      <label><input type="checkbox" id="autoUpdateCheck">Auto Update</label>
      <label><input type="number" id="interval"/>Interval (s)</label>
      <label><input type="number" id="rows"/>Number of Rows</label>
      <label><input type="number" id="timespawn"/>Timespawn (s)</label>
      </buttons>

      <span id="metrics" value=-1></span>
      <span id="pocGraph"></span>

      <script type="text/javascript">
         var timerId;
         var nowTime;
         var timeSpawn = -1;
         var arrData = {};

         function checkAutoUpdate(){
            return !document.getElementById("autoUpdateCheck").checked && document.getElementById("update").value == "Update";
         }

         function retrieveVal(txt){
            var val = document.getElementById(txt).value;
            if(isNaN(val)){
               return 0;
            }else if(val <= 0){
               return 0;
            }else{
               return val;
            }
         }

         function autoUpdateMetrics(){
            if(document.getElementById("update").value == "Update"){
               var val = retrieveVal("interval");
               if(timeSpawn == -1){
                  timeSpawn = retrieveVal("timespawn");
               }
               if(val != 0){
                  document.getElementById("update").value = "Stop";
                  $('#update').text("Stop");
                  timerId = setInterval(updateM, val * 1000);
               }
            }else{
               document.getElementById("update").value = "Update";
               $('#update').text("Update");
               timeSpawn = -1;
               clearTimeout(timerId);
            }
         }
         function updateMetrics(){
            if(checkAutoUpdate()){
               updateM();
            }else{
               updateM();
               autoUpdateMetrics();
            }
         }
         //This is just here for testing purposes so I don't forget something while I code...
         function testingfun(txt){
            console.log(txt);
         }

         function updateM(){
            nowTime = $.now();
            var Gmetad = "http://"+window.location.hostname+":8652/status";
            $.ajax({
            type: "GET",
            url: Gmetad,
            dataType: "jsonp",
            crossDomain: true,
            contentType: "application/json",
            jsonpCallback: "jsonCallback",
            error: function(data, textStatus, jqXHR) { alert("Update crashed, please reload the page..."); console.log(textStatus + " " + jqXHR.responseText);}
            /* If the logged error is "parsererror undefined", then the ajax() call couldn't parse the json data
            because there was a conflict with another call to ajax(), and sometimes the metrics won't update anymore. */
            });
         }

         function updateG(data){
            $.each(arrData, function(key, val) {
               drawGraph(key, val);
            });
         }
         var speedKeyUp = {"host":false, "gridname":false, "version":false, "boottime":false, "uptime":false,
         "uptimeMillis":false, "cpu_num":false, "cpu_speed":false, "disk_total":false, "mem_total":false,
         "swap_total":false, "sys_clock":false, "machine_type":false, "os_name":false, "os_release":false};
         function testkey(key){
            if(speedKeyUp.hasOwnProperty(key)){
               return false;
            }else{
               return true;
            }
         }
         var speedMetricUp = {"metrics":false, "core":false, "cpu":false, "disk":false, "load":false, "memory":false, "network":false,
         "process":false, "system":false, "other":false, "received":false, "sent":false};
         function testmetric(key){
            if(speedMetricUp.hasOwnProperty(key)){
               return true;
            }else{
               return false;
            }
         }

         function jsonCallback(data){
            if($("#metrics").attr('value') == -1){
               var tmp = linearTableTh(data, data.stattime);
               tmp += '<tr>' + linearTable(data, data.stattime) + '</tr>';
               $("#metrics").html('<table>' + tmp + '</table>');
               $("#metrics").attr('value', 0);
            }else{
               tmp += '<tr>' + linearTable(data, data.stattime) + '</tr>';
               $("#metrics tr:nth-child(1)").after(tmp);
            }
            var val = retrieveVal("rows");
            val = val > 0 ? val : 1;
            var currentVal = $("#metrics").attr('value');
            currentVal ++;
            while(currentVal > val){
               $("#metrics tr:last").remove();
               currentVal --;
            }
            $("#metrics").attr('value', currentVal);
            updateG(data);
         }

         function linearTableTh(data, time){
            var txt = "";
            $.each(data, function(key, val) {
               if(testmetric(key)){
                     txt += linearTableTh(val, time);
               }else if(key == "stattime"){
                  txt +='<th>' + key + '</th>';
                  txt +='<th>call delay</th>';
                  txt +='<th>metrics delay</th>';
                  arrData["call_delay"] = [];
                  arrData["metrics_delay"] = [];
                  arrData["call_delay"].push([time, ($.now() - nowTime)]);
                  arrData["metrics_delay"].push([time, ($.now() - val/1000)]);
               }else{
                  txt +='<th>' + key + '</th>';//will change with css
                  if(testkey(key)){
                     arrData[key] = [];
                     arrData[key].push([time, val]);
                  }
               }
            });
            return txt;
         }

         function linearTable(data, time){
            var txt = "";
            $.each(data, function(key, val) {
               if(testmetric(key)){
                     txt += linearTable(val, time);
               }else if(key == "stattime"){
                  txt +='<td>' + val + '</td>';
                  txt +='<td>' + ($.now() - nowTime) + '</td>';
                  txt +='<td>' + ($.now() - val/1000) + '</td>';
                  arrData["call_delay"].push([time, ($.now() - nowTime)]);
                  arrData["metrics_delay"].push([time, ($.now() - val/1000)]);
               }else{
                  txt +='<td>' + val + '</td>';//will change with css
                  if(testkey(key)){
                     arrData[key].push([time, val]);
                  }
               }
            });
            return txt;
         }

      function testTime(val){
         if(timeSpawn > 0){
            return $.now() - timeSpawn <= val ? val : null;
         }
         return val;
      }

      function drawGraph(label, arr){
         d3.select("#"+label).remove();

         var margin = {top: 20, right: 20, bottom: 30, left: 50},
            width = 750 - margin.left - margin.right,
            height = 300 - margin.top - margin.bottom;

         var x = d3.time.scale()
            .range([0, width])

         var y = d3.scale.linear()
            .range([height, 0]);

         var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

         var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

         var line = d3.svg.line()
            .x(function(d) { return x(d.date); })
            .y(function(d) { return y(d.close); });

         var svg = d3.select("body").append("svg")
            .attr("id",label)
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

         var data = arr.map(function(d) {
            return {
               date: d[0] / 1000,
               close: d[1]
            };
         });

         x.domain(d3.extent(data, function(d) { return d.date; }));
         y.domain(d3.extent(data, function(d) { return d.close; }));

         svg.append("g")
               .attr("class", "x axis")
               .attr("transform", "translate(0," + height + ")")
               .call(xAxis)
            .append("text")
               .attr("y", 6)
               .attr("dy", ".71em")
               .style("text-anchor", "end")
               .text("Time");

         svg.append("g")
               .attr("class", "y axis")
               .call(yAxis)
            .append("text")
               .attr("transform", "rotate(-90)")
               .attr("y", 6)
               .attr("dy", ".71em")
               .style("text-anchor", "end")
               .text(label);

         svg.append("path")
               .datum(data)
               .attr("class", "line")
               .attr("d", line);
         }
      </script>

   </body>

</html>