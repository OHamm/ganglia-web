<!DOCTYPE html>
<html>

   <head>
      <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
      <meta content="utf-8" http-equiv="encoding">
      <script type="text/javascript" src="jquery-1.9.1.min.js"></script>
      <script type="text/javascript" src="d3.v3.min.js"></script>
      <link rel="stylesheet" type="text/css" href="stylesheet.css"/>
   </head>

   <body>
      <h2>Testing metrics</h2>
      <buttons>
      <button type="button" id="update" value="Update" onclick="updateMetrics()">Update</button>
      <label><input type="checkbox" id="autoUpdateCheck">Auto Update</label>
      <label><input type="number" id="interval"/>Interval(s)</label>
      <label><input type="number" id="rows"/>Number of Rows</label>
      </buttons>

      <span id="metrics" value=0></span>

      <script type="text/javascript">
      var timerId;
      var nowTime;
      //TODO add graphs && table
         function checkAutoUpdate(){
            return !document.getElementById("autoUpdateCheck").checked && document.getElementById("update").value == "Update";
         }

         function retrieveVal(txt){
            var val = document.getElementById(txt).value;
            if(isNaN(val)){
               return 0;
            }else if(val <= 0){
               return 0;
            }else{
               return val;
            }
         }

         function autoUpdateMetrics(){
            if(document.getElementById("update").value == "Update"){
               var val = retrieveVal("interval");
               if(val != 0){
                  document.getElementById("update").value = "Stop";
                  $('#update').text("Stop");
                  timerId = setInterval(updateM, val * 1000);
               }
            }else{
               document.getElementById("update").value = "Update";
               $('#update').text("Update");
               clearTimeout(timerId);
            }
         }
         function updateMetrics(){
            if(checkAutoUpdate()){
               updateM();
            }else{
               updateM();
               autoUpdateMetrics();
            }
         }
         //This is just here for testing purposes so I don't forget something while I code...
         function testingfun(txt){
            console.log(txt);
         }

         function updateM(){
            nowTime = $.now();
            var Gmetad = "http://localhost:8652/status";
            $.ajax({
            type: "GET",
            url: Gmetad,
            dataType: "jsonp",
            crossDomain: true,
            contentType: "application/json",
            jsonpCallback: "jsonCallback",
            error: function(data, textStatus, jqXHR) { alert("Update crashed, please reload the page..."); console.log(textStatus + " " + jqXHR.responseText);}
            /* If the logged error is "parsererror undefined", then the ajax() call couldn't parse the json data
            because there was a conflict with another call to ajax(), and sometimes the metrics won't update anymore. */
            });
         };

         function jsonCallback(data){
            testingfun(data);
            if($("#metrics").attr('value') == 0){
               var tmp = linearTableTh(data);
               tmp += '<tr>' + linearTable(data) + '</tr>';
               $("#metrics").html('<table>' + tmp + '</table>');
            }else{
               tmp += '<tr>' + linearTable(data) + '</tr>';
               $("#metrics tr:nth-child(1)").after(tmp);
            }
            var val = retrieveVal("rows");
            val = val > 0 ? val : 1;
            var currentVal = $("#metrics").attr('value');
            currentVal ++;
            while(currentVal > val){
               $("#metrics tr:last").remove();
               currentVal --;
            }
            $("#metrics").attr('value', currentVal);
         }
         function linearTableTh(data){
            var txt = "";
            $.each(data, function(key, val) {
               if(key == "metrics"){
                  txt += linearTableTh(val);
               }else if(key == "core" || key == "cpu" ||
                  key == "disk" || key == "load" || key == "memory" ||
                  key == "network" || key == "process" || key == "system" ||
                  key == "other" || key == "received" || key == "sent"){
                     txt += linearTableTh(val);
               }else if(key == "localtime"){
                  txt +='<th>' + key + '</th>';
                  txt +='<th>call delay</th>';
                  txt +='<th>metrics delay</th>';
               }else{
                     txt +='<th>' + key + '</th>';//will change with css
               }
            });
            return txt;
         }
         function linearTable(data){
            var txt = "";
            $.each(data, function(key, val) {
               if(key == "metrics" || key == "core" || key == "cpu" ||
                  key == "disk" || key == "load" || key == "memory" ||
                  key == "network" || key == "process" || key == "system" ||
                  key == "other" || key == "received" || key == "sent"){
                     txt += linearTable(val);
               }else if(key == "localtime"){
                  txt +='<td>' + val + '</td>';
                  txt +='<td>' + ($.now()-nowTime) + '</td>';
                  txt +='<td>' + ($.now()-val) + '</td>';
               }else{
                     txt +='<td>' + val + '</td>';//will change with css
               }
            });
            return txt;
         }
      </script>

   </body>

</html>