<body>
   <div id="metricsStyle" name="int">
      <div id="buttons">
         <ul>
            <li>
               <button type="button" id="update" value="Update" onclick="updateMetrics()">Update</button>
               <label><input type="checkbox" id="autoUpdateCheck">Auto Update</label>
               <label>
                  <select id="interval">
                     <option value=2>2</option>
                     <option value=5>5</option>
                     <option value=15>15</option>
                     <option value=30>30</option>
                     <option value=60>60</option>
                  </select>
               Interval (s)</label>
            </li>
            <li>
               <label>
                  <select id="timespawn">
                     <option value=5>5</option>
                     <option value=10>10</option>
                     <option value=20>20</option>
                     <option value=30>30</option>
                     <option value=60>60</option>
                     <option value=120>120</option>
                     <option value=-1>âˆž</option>
                  </select>
               Timespawn (min)</label>
            </li>
            <li>
               <label>
                  <select id="rows">
                     <option value=1>1</option>
                     <option value=5>5</option>
                     <option value=10>10</option>
                     <option value=20>20</option>
                     <option value=50>50</option>
                     <option value=100>100</option>
                  </select>
               Number of table rows</label>
            </li>
            <li>
               <label>
                  <select id="graph_size" onchange="checkManual()">
                     <option value="small">small</option>
                     <option value="normal">normal</option>
                     <option value="big">big</option>
                     <option value="huge">huge</option>
                     <option value="manual">manual</option>
                  </select>
               Graph size</label>
            </li>
         </ul>
         <ul id="manualGraphSize" class="manualGraphSize">
            <li>
               <label><input type="number" id="graphs_width"/> Width (px)</label>
            </li>
            <li>
               <label><input type="number" id="graphs_height"/> Height (px)</label>
            </li>
         </ul>
      </div>
      
      <span id="metrics" value=-1></span>

      <script type="text/javascript">
         var timerId;
         var nowTime;
         var arrData = {};
         var graphShown = {};
         
         function checkManual(){
            var list = document.getElementById("manualGraphSize");
            if(retrieveDropVal("graph_size") == "manual"){
               list.style.display = "block";
            }else{
               list.style.display = "none";
            }
         }
         
         function checkAutoUpdate(){
            return !document.getElementById("autoUpdateCheck").checked && document.getElementById("update").value == "Update";
         }

         function retrieveVal(txt){
            var val = document.getElementById(txt).value;
            return (isNaN(val) || val <= 0) ? 0 : val;
         }
         
         function retrieveDropVal(txt){
            var e = document.getElementById(txt);
            return e.options[e.selectedIndex].value;
         }
         
         function retriveGraphSize(){
            switch (retrieveDropVal("graph_size")){
               case "small":
                  return [300, 150];
               case "normal":
                  return [600, 300];
               case "big":
                  return [900, 400];
               case "huge":
                  return [1500, 400];
               case "manual":
                  var tmpWidth = retrieveVal("graphs_width");
                  var tmpHeight = retrieveVal("graphs_height");
                  return [(tmpWidth > 0 ? tmpWidth : 600), (tmpHeight > 0 ? tmpHeight : 300)];
               default:
                  return [300, 150];
            }
         }

         function autoUpdateMetrics(){
            if(document.getElementById("update").value == "Update"){
               var val = retrieveDropVal("interval");
               if(val != 0){
                  document.getElementById("update").value = "Stop";
                  $('#update').text("Stop");
                  timerId = setInterval(updateM, val * 1000);
               }
            }else{
               document.getElementById("update").value = "Update";
               $('#update').text("Update");
               clearTimeout(timerId);
            }
         }
         function updateMetrics(){
            if(checkAutoUpdate()){
               updateM();
            }else{
               updateM();
               autoUpdateMetrics();
            }
         }
         //This is just here for testing purposes so I don't forget something while I code...
         function testingfun(txt){
            console.log(txt);
         }

         function updateM(){
            nowTime = $.now();
            var Gmetad = "http://" + window.location.hostname + ":8652/status";
            $.ajax({
            type: "GET",
            url: Gmetad,
            dataType: "jsonp",
            crossDomain: true,
            contentType: "application/json",
            jsonpCallback: "jsonCallback",
            error: function(data, textStatus, jqXHR) { alert("Update crashed, please reload the page..."); console.log(textStatus + " " + jqXHR.responseText);}
            /* If the logged error is "parsererror undefined", then the ajax() call couldn't parse the json data
            because there was a conflict with another call to ajax(), and sometimes the metrics won't update anymore. */
            });
         }

         var speedKeyUp = {"host":false, "gridname":false, "version":false, "boottime":false, "uptime":false,
         "uptimeMillis":false, "cpu_num":false, "cpu_speed":false, "disk_total":false, "mem_total":false,
         "swap_total":false, "sys_clock":false, "machine_type":false, "os_name":false, "os_release":false};
         function testkey(key){
            return !speedKeyUp.hasOwnProperty(key);
         }

         var speedMetricUp = {"core":false, "cpu":false, "disk":false, "load":false, "memory":false, "network":false,
         "process":false, "system":false, "other":false, "received":false, "sent":false};
         function testmetric(key){
            return speedMetricUp.hasOwnProperty(key);
         }

         function jsonCallback(data){
            if($("#metrics").attr('value') == -1){
               $("#metrics").html(linearTableTh(data, data.stattime/1000));
               $("#metrics").attr('value', 0);
               linearTable(data, data.stattime/1000);
            }else{
               linearTable(data, data.stattime/1000);
               $("#metrics").attr('value', +$("#metrics").attr('value') + 1);
            }
            var val = retrieveDropVal("rows");
            val = val > 0 ? val : 1;
            var currentVal = +$("#metrics").attr('value');
            var currentVarTmp;
            $.each($("#metrics table"),function(){
               currentVarTmp = currentVal;
               while(currentVarTmp >= val){
                  $("#metrics #" + this.id + " tr:last").remove();
                  currentVarTmp --;
               }
            });
            $("#metrics").attr('value', currentVarTmp);
         }

         function turnGraphOnOff(key){
            graphShown[key] = !graphShown[key];
            if(graphShown[key]){
               drawGraph(key, arrData[key]);
            }else{
               d3.select("#"+key).remove();
            }
         }

         function linearTableTh(data, time){
            var txt = "";
            $.each(data, function(key, val) {
               if(key == "metrics"){
                  txt = '<h1>general:</h1><table id="general">' + txt + '</table>';
                  txt += linearTableTh(val, time);
               }else if(testmetric(key)){
                  txt += '<h1>' + key + ':</h1><table id="' + key + '">' + linearTableTh(val, time) + '</table>';
               }else if(key == "stattime"){
                  txt +='<th>' + key + '</th>';
                  arrData["call_delay"] = [];
                  arrData["call_delay"].push([time, ($.now() - nowTime)]);
                  txt +='<th><button onclick="turnGraphOnOff(\'call_delay\')">call_delay</button></th>';
                  graphShown["call_delay"] = false;
               }else{
                  if(testkey(key)){
                     txt +='<th><button onclick="turnGraphOnOff(\'' + key + '\')">' + key + '</button></th>';
                     graphShown[key] = false;
                     arrData[key] = [];
                     arrData[key].push([time, val]);
                  }else{
                     txt +='<th>' + key + '</th>';
                  }
               }
            });
            return txt;
         }

         function linearTable(data, time){
            var txt = "";
            $.each(data, function(key, val) {
               if(key == "metrics"){
                  $("#metrics #general tr:nth-child(1)").after('<tr>' + txt + '</tr>');
                  linearTable(val, time);
               }else if(testmetric(key)){
                  $("#metrics #" + key + " tr:nth-child(1)").after('<tr>' + linearTable(val, time) + '</tr>');
               }else if(key == "stattime"){
                  txt +='<td>' + val + '</td>';
                  txt +='<td>' + ($.now() - nowTime) + '</td>';
                  arrData["call_delay"].push([time, ($.now() - nowTime)]);
                  if(graphShown["call_delay"]){
                     drawGraph("call_delay", arrData["call_delay"]);
                  }
               }else{
                  txt +='<td>' + val + '</td>';
                  if(testkey(key)){
                     arrData[key].push([time, val]);
                     if(graphShown[key]){
                        drawGraph(key, arrData[key]);
                     }
                  }
               }
            });
            return txt;
         }
      function checkTimeSpawn(data){
         var timeVal = retrieveDropVal("timespawn");
         if(timeVal != -1){
            var i = 0;
            for(; i< data.length; i++){
               if(data[i][0] >= (nowTime - (timeVal * 60000))){
                  break;
               }
            }
            data = data.splice(0,i);//array is sorted!
         }
      }
         
      function drawGraph(label, data){
         d3.select("#"+label).remove();
         var tmpSize = retriveGraphSize();
            checkTimeSpawn(data);

         var margin = {top: 20, right: 20, bottom: 30, left: 50},
            width = tmpSize[0] - margin.left - margin.right,
            height = tmpSize[1] - margin.top - margin.bottom;

         var x = d3.time.scale()
            .range([0, width])

         var y = d3.scale.linear()
            .range([height, 0]);

         var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

         var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

         var line = d3.svg.line()
            .x(function(d) { return x(d[0]); })
            .y(function(d) { return y(d[1]); });

         var svg = d3.select("#metrics").insert("svg")
            .attr("id",label)
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

         x.domain(d3.extent(data, function(d) { return d[0]; }));
         y.domain(d3.extent(data, function(d) { return d[1]; }));

         svg.append("g")
               .attr("class", "x axis")
               .attr("transform", "translate(0," + height + ")")
               .call(xAxis)
            .append("text")
               .attr("y", 6)
               .attr("dy", ".71em")
               .style("text-anchor", "end")
               .text("Time");

         svg.append("g")
               .attr("class", "y axis")
               .call(yAxis)
            .append("text")
               .attr("transform", "rotate(-90)")
               .attr("y", 6)
               .attr("dy", ".71em")
               .style("text-anchor", "end")
               .text(label);

         svg.append("path")
               .datum(data)
               .attr("class", "line")
               .attr("d", line);
      }
      $(document).ready(function() {
         updateM();
      });
      </script>
   </div>
</body>